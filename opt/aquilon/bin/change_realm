#!/usr/bin/python
import subprocess
import re
import sys
import os
import shutil

realm_re = re.compile('(\s*default_realm\s*=\s*)([a-zA-Z.]*)')
valid_re = re.compile('[A-Z.]*$')
if not valid_re.match(sys.argv[1]):
    sys.stderr.write("realm '%s' is not valid\n" % sys.argv[1])
    exit(1)

fd = open("/etc/krb5.conf")
out = open("/etc/krb5.conf.NEW", "w")
for line in fd.readlines():
    m = realm_re.match(line)
    if m is not None:
        line = realm_re.sub('\\1' + sys.argv[1], line)
    out.write(line)
out.close()
fd.close()

shutil.copyfile("/etc/krb5.conf", "/etc/krb5.conf.OLD")
os.rename("/etc/krb5.conf.NEW", "/etc/krb5.conf")
exit(0)
